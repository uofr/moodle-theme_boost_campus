{"version":3,"sources":["../src/modal_help.js"],"names":["SELECTORS","SEARCH","SEARCH_BUTTON","SUGGESTIONS","SUGGESTION_ITEM","SUGGESTION_ITEM_SEL","TEMPLATES","LOADING","MODAL_HELP_CONTENT","MODAL_HELP_TOPICS","ModalHelp","root","courseId","currentUrl","topicList","searchBox","modal","find","searchButton","suggestionBox","setCourseId","setCurrentUrl","getRoot","on","ModalEvents","shown","initContent","getSearchBox","searchValue","val","updateSuggestionBox","showSuggestionBox","e","target","getSuggestionBox","hideSuggestionBox","getSearchButton","doSearch","keyCode","KeyCodes","enter","getModal","focus","CustomEvents","events","activate","suggestionValue","attr","courseid","getCourseId","currenturl","getCurrentUrl","ModalHelpAjax","getTopicList","getLandingPage","landingPage","renderPromise","Templates","render","html","searchBoxValue","setTopicList","setBody","console","error","Notification","exception","topic","title","toLowerCase","url","substr","indexOf","getGuidePage","guidePage","suggestions","suggestion","suggestionMarkup","append","filter","generateSuggestions","setSuggestionBox","topics","regex","RegExp","split","join","match","exec","push","length","start","index","sort","a","b","removeClass","addClass","Modal","registered","ModalRegistry","register","getType"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Theme Boost Campus - ModalHelp class\n *\n * @package    theme_urcourses_default\n * @author     John Lane\n *\n */\n\nimport $ from 'jquery';\nimport Notification from 'core/notification';\nimport Templates from 'core/templates';\nimport CustomEvents from 'core/custom_interaction_events';\nimport KeyCodes from 'core/key_codes';\nimport Modal from 'core/modal';\nimport ModalEvents from 'core/modal_events';\nimport ModalRegistry from 'core/modal_registry';\nimport ModalHelpAjax from 'theme_urcourses_default/modal_help_ajax';\n\nconst SELECTORS = {\n    SEARCH: '#modal_help_search',\n    SEARCH_BUTTON: '#modal_help_search_btn',\n    SUGGESTIONS: '#modal_help_search_suggestions',\n    SUGGESTION_ITEM: '.modal-help-suggestion-item',\n    SUGGESTION_ITEM_SEL: '.modal-help-suggestion-item.selected'\n};\n\nconst TEMPLATES = {\n    LOADING: 'core/loading',\n    MODAL_HELP_CONTENT: 'theme_urcourses_default/modal_help_content',\n    MODAL_HELP_TOPICS: 'theme_urcourses_default/modal_help_topics'\n};\n\nexport default class ModalHelp extends Modal {\n\n    constructor(root) {\n        super(root);\n        this.courseId = null;\n        this.currentUrl = null;\n        this.topicList = null;\n        this.searchBox = this.modal.find(SELECTORS.SEARCH);\n        this.searchButton = this.modal.find(SELECTORS.SEARCH_BUTTON);\n        this.suggestionBox = this.modal.find(SELECTORS.SUGGESTIONS);\n    }\n\n    init(courseId, currentUrl) {\n        this.setCourseId(courseId);\n        this.setCurrentUrl(currentUrl);\n\n        this.getRoot().on(ModalEvents.shown, () => {\n            this.initContent();\n        });\n        this.getSearchBox().on('input', () => {\n            const searchValue = this.getSearchBox().val();\n            this.updateSuggestionBox(this.topicList, searchValue);\n        });\n        this.getSearchBox().on('focus', () => {\n            const searchValue = this.getSearchBox().val();\n            this.updateSuggestionBox(this.topicList, searchValue);\n            this.showSuggestionBox();\n        });\n        this.getRoot().on('click', (e) => {\n            if (e.target !== this.getSearchBox()[0] && e.target !== this.getSuggestionBox()[0]) {\n                this.hideSuggestionBox();\n            }\n        });\n        this.getSearchButton().on('click', () => {\n            this.doSearch();\n        });\n        this.getSearchBox().on('keydown', (e) => {\n            if (e.keyCode === KeyCodes.enter) {\n                this.getModal().focus();\n                this.hideSuggestionBox();\n                this.doSearch();\n            }\n        });\n        this.getSuggestionBox().on(CustomEvents.events.activate, SELECTORS.SUGGESTION_ITEM, (e) => {\n            const suggestionValue = $(e.target).attr('data-value');\n            this.getSearchBox().val(suggestionValue);\n            this.doSearch();\n        });\n    }\n\n    async initContent() {\n        const courseid = this.getCourseId();\n        const currenturl = this.getCurrentUrl();\n        try {\n            const topicList = await ModalHelpAjax.getTopicList(courseid);\n            const landingPage = await ModalHelpAjax.getLandingPage(courseid, currenturl);\n            const renderPromise = Templates.render(TEMPLATES.MODAL_HELP_CONTENT, {html: landingPage.html});\n            const searchBoxValue = this.getSearchBox().val();\n\n            this.setTopicList(topicList);\n            this.updateSuggestionBox(topicList, searchBoxValue);\n            this.setBody(renderPromise);\n        } catch (error) {\n            console.error('error', error);\n            Notification.exception(error);\n        }\n    }\n\n    async doSearch() {\n        const searchValue = this.getSearchBox().val();\n        const topic = this.topicList.find(topic => topic.title.toLowerCase() === searchValue.toLowerCase());\n        const url = topic.url.substr(topic.url.indexOf('/', 1));\n\n        if (!topic) {\n            return;\n        }\n        try {\n            const guidePage = await ModalHelpAjax.getGuidePage(url);\n            const renderPromise = Templates.render(TEMPLATES.MODAL_HELP_CONTENT, {html: guidePage.html});\n            this.setBody(renderPromise);\n        } catch (error) {\n            Notification.exception(error);\n        }\n    }\n\n    static getType() {\n        return 'theme_urcourses_default-help';\n    }\n\n    setCourseId(courseId) {\n        this.courseId = courseId;\n    }\n\n    getCourseId() {\n        return this.courseId;\n    }\n\n    setCurrentUrl(currentUrl) {\n        this.currentUrl = currentUrl;\n    }\n\n    getCurrentUrl() {\n        return this.currentUrl;\n    }\n\n    setTopicList(topicList) {\n        this.topicList = topicList;\n    }\n\n    getTopicList() {\n        return this.topicList;\n    }\n\n    getSearchBox() {\n        return this.searchBox;\n    }\n\n    getSearchButton() {\n        return this.searchButton;\n    }\n\n    getSuggestionBox() {\n        return this.suggestionBox;\n    }\n\n    setSuggestionBox(suggestions) {\n        const suggestionBox = this.getSuggestionBox();\n        suggestionBox.html('');\n        for (const suggestion of suggestions) {\n            const suggestionMarkup = `<a href=\"#\"\n                                        class=\"modal-help-suggestion-item\"\n                                        data-url=\"${suggestion.url}\"\n                                        data-value=\"${suggestion.title}\">\n                                            ${suggestion.title}\n                                      </a>`;\n            suggestionBox.append(suggestionMarkup);\n        }\n    }\n\n    updateSuggestionBox(topicList, filter) {\n        const suggestions = this.generateSuggestions(topicList, filter);\n        this.setSuggestionBox(suggestions);\n    }\n\n    generateSuggestions(topics, filter) {\n        const regex = RegExp(filter.split('').join('.*'), 'i');\n        const suggestions = [];\n        for (const topic of topics) {\n            const match = regex.exec(topic.title);\n            if (match) {\n                suggestions.push({\n                    title: topic.title,\n                    url: topic.url,\n                    length: match[0].length,\n                    start: match.index\n                });\n            }\n        }\n        suggestions.sort((a, b) => {\n            if (a.start < b.start) {\n                return -1;\n            }\n            if (a.start > b.start) {\n                return 1;\n            }\n            if (a.length < b.length) {\n                return -1;\n            }\n            if (a.length > b.length) {\n                return 1;\n            }\n        });\n        return suggestions;\n    }\n\n    showSuggestionBox() {\n        this.getSuggestionBox().removeClass('d-none');\n    }\n\n    hideSuggestionBox() {\n        this.getSuggestionBox().addClass('d-none');\n    }\n\n}\n\n// Setup code for adding ModalHelp to the modal factory.\nlet registered = false;\nif (!registered) {\n    ModalRegistry.register(ModalHelp.getType(), ModalHelp, 'theme_urcourses_default/modal_help');\n    registered = true;\n}"],"file":"modal_help.min.js"}